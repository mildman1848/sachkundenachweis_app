# Speicherort: .github/workflows/build.yml
# Beschreibung: Automatisiert den Build- und Release-Prozess der Sachkundenachweis-App.
# FÃ¼hrt Tests, generiert CHANGELOG, aktualisiert die Version, baut APK und AppBundle, und erstellt ein GitHub-Release.
# Der Workflow ist plattformÃ¼bergreifend kompatibel und folgt Best Practices fÃ¼r CI/CD.

name: ğŸ“¦ Build APK & Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: ğŸ§ª Build & Release
    runs-on: ubuntu-latest

    steps:
      # Schritt 1: Repository auschecken
      - name: â¬‡ï¸ Repository auschecken
        uses: actions/checkout@v4

      # Schritt 2: Flutter SDK einrichten
      - name: ğŸ› ï¸ Flutter SDK einrichten
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          cache: true # Cache fÃ¼r Flutter-AbhÃ¤ngigkeiten aktivieren
          cache-key: flutter-${{ hashFiles('**/pubspec.lock') }}
          cache-path: ${{ runner.tool_cache }}/flutter

      # Schritt 3: Node.js einrichten
      - name: ğŸ§° Node.js einrichten
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Cache fÃ¼r Node.js-AbhÃ¤ngigkeiten

      # Schritt 4: Node.js-AbhÃ¤ngigkeiten installieren (standard-version)
      - name: ğŸ“¦ Node.js-AbhÃ¤ngigkeiten installieren
        run: npm install

      # Schritt 5: Git-Autor fÃ¼r CI konfigurieren
      - name: ğŸ§‘â€ğŸ’» Git-Autor fÃ¼r CI konfigurieren
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # Schritt 6: CHANGELOG generieren und Version bumpen
      - name: ğŸ§¾ CHANGELOG.md generieren und Version bumpen
        run: npx standard-version

      # Schritt 7: Neue Version aus package.json extrahieren
      - name: ğŸ·ï¸ Neue Version aus package.json extrahieren
        id: extract_tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Schritt 8: pubspec.yaml Version aktualisieren
      - name: ğŸ”„ pubspec.yaml Version aktualisieren
        run: |
          version=${{ steps.extract_tag.outputs.version }}
          sed -i "s/^version: .*/version: $version/" pubspec.yaml

      # Schritt 9: Git Commit, Tag und Push (CHANGELOG + pubspec.yaml)
      - name: ğŸ” Git Commit, Tag und Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md pubspec.yaml package.json package-lock.json
          git commit -m "ğŸ”– Release v${{ steps.extract_tag.outputs.version }}" || echo "Keine Ã„nderungen zu committen"
          git tag -d "v${{ steps.extract_tag.outputs.version }}" || true
          git push --delete origin "v${{ steps.extract_tag.outputs.version }}" || true
          git tag "v${{ steps.extract_tag.outputs.version }}"
          git push origin main --follow-tags

      # Schritt 10: Flutter-AbhÃ¤ngigkeiten installieren
      - name: ğŸ“¦ Flutter-AbhÃ¤ngigkeiten installieren
        run: flutter pub get

      # Schritt 11: Flutter-Tests ausfÃ¼hren
      - name: ğŸ§ª Flutter-Tests ausfÃ¼hren
        run: flutter test
        continue-on-error: false # Stoppt den Workflow bei fehlgeschlagenen Tests

      # Schritt 12: Android App Icon generieren
      - name: ğŸ¨ Android App Icon generieren
        run: flutter pub run flutter_launcher_icons:main -f pubspec.yaml

      # Schritt 13: Release APK bauen
      - name: ğŸ—ï¸ Release APK bauen
        run: flutter build apk --release

      # Schritt 14: Release AppBundle bauen
      - name: ğŸ—ï¸ Release AppBundle bauen
        run: flutter build appbundle --release

      # Schritt 15: GitHub Release erstellen
      - name: ğŸ—‚ GitHub Release erstellen
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.extract_tag.outputs.version }}
          name: Release v${{ steps.extract_tag.outputs.version }}
          body_path: ./CHANGELOG.md
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}