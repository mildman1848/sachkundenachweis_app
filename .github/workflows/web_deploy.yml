# Speicherort: .github/workflows/web_deploy.yml
# Beschreibung: Automatisiert den Build- und Deployment-Prozess der Flutter-Web-App auf GitHub Pages.
# FÃ¼hrt Tests, baut die Web-App und deployed sie auf GitHub Pages mit korrektem base-href.
# Der Workflow ist plattformÃ¼bergreifend kompatibel und folgt Best Practices fÃ¼r CI/CD.

name: ğŸš€ Deploy Flutter Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    name: ğŸŒ Build & Deploy Flutter Web
    runs-on: ubuntu-latest

    steps:
      # Schritt 1: Repository auschecken
      - name: â¬‡ï¸ Repository auschecken
        uses: actions/checkout@v4

      # Schritt 2: Flutter SDK einrichten
      - name: ğŸ› ï¸ Flutter SDK einrichten
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          channel: stable
          cache: true # Cache fÃ¼r Flutter-AbhÃ¤ngigkeiten aktivieren
          cache-key: flutter-${{ hashFiles('**/pubspec.lock') }}
          cache-path: ${{ runner.tool_cache }}/flutter

      # Schritt 3: Flutter-AbhÃ¤ngigkeiten installieren
      - name: ğŸ“¦ Flutter-AbhÃ¤ngigkeiten installieren
        run: flutter pub get

      # Schritt 4: Flutter-Tests ausfÃ¼hren
      - name: ğŸ§ª Flutter-Tests ausfÃ¼hren
        run: flutter test
        continue-on-error: false # Stoppt den Workflow bei fehlgeschlagenen Tests

      # Schritt 5: Version aus pubspec.yaml extrahieren
      - name: ğŸ·ï¸ Version aus pubspec.yaml extrahieren
        id: extract_version
        run: |
          VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Schritt 6: Flutter Web bauen
      - name: ğŸ—ï¸ Flutter Web bauen
        run: flutter build web --release --base-href="/sachkundenachweis_app/"

      # Schritt 7: Web-Build als Artefakt speichern
      - name: ğŸ“¤ Web-Build als Artefakt speichern
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7 # Artefakte fÃ¼r 7 Tage speichern

      # Schritt 8: Auf GitHub Pages deployen
      - name: ğŸš€ Auf GitHub Pages deployen
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/web
          force_orphan: true
          commit_message: "Deploy Web-App v${{ steps.extract_version.outputs.version }} zu GitHub Pages"